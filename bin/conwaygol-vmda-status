#!/bin/sh

LANG=C

pname="$(basename "$0")"
stime="$(date +%Y%m%d%H%M%S)"
tmp="/tmp/$pname.$stime.$$"

trap 'rm -f $tmp-*' EXIT

######################################################################

pattern=${1:-"-"}

step=${2}
sleep=${3:-"0"}

X=${4:-"$(tput cols)"}
Y=${5:-"$(tput lines)"}

dX=${6:-"0"}
dY=${7:-"0"}

######################################################################

######################################################################

printf "\033[1;1H\033[2J\n"

# Initialize
conwaygol-vmda-encode "$pattern" "$X" "$Y" "$dX" "$dY"	|
    tee "$tmp-cell_vmda.STATUS"	|
    conwaygol-vmda-decode	|
    awk '{
		printf("\033[%d;1H%s\n", NR, $0)
	}'			|
    tee "$tmp-screen.STATUS"	|
    {
	tr -d '\n'
	printf "\033[1;1H\n"
    }

yes ""			|
    if [ "$step" ] ; then
	head -n "$step"
    else
	cat
    fi			|
while read ; do
    sleep "$sleep"

    conwaygol-vmda-core "$tmp-cell_vmda.STATUS"	|
	tee "$tmp-cell_vmda.STATUS.next"	|
	conwaygol-vmda-decode			|
	awk '{	printf("\033[%d;1H%s\n", NR, $0)	}'|
	tee "$tmp-screen.STATUS.next"		|
	diff "$tmp-screen.STATUS" -		|
	grep '^>'				|
	sed -e 's/^> //'			|
	{
	    tr -d '\n'		|
	    tee "$tmp-out"
	    printf "\033[1;1H\n"
	}

    [ -s "$tmp-out" ]	||	break

    mv "$tmp-cell_vmda.STATUS.next" "$tmp-cell_vmda.STATUS"
    mv "$tmp-screen.STATUS.next" "$tmp-screen.STATUS"
done

printf "\033[1;1H\033[2J\n"

######################################################################
exit 0
