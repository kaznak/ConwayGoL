#!/bin/sh

LANG=C

pname="$(basename "$0")"
stime="$(date +%Y%m%d%H%M%S)"
tmp="/tmp/$pname.$stime.$$"

trap 'rm -f $tmp-*' EXIT

######################################################################

pattern=${1:-"-"}

X=${2:-"10"}
Y=${3:-"10"}

######################################################################

tr '\0' '_'	< /dev/zero	|
    fold -w $((X + 2))		|
    head -n 1	> "$tmp-line"

# append outer cells
awk '
	BEGIN{	print "'$(cat "$tmp-line")'"	}
	{	print "_" $0 "_"	}
	END{	print "'$(cat "$tmp-line")'"	}
' "$pattern"		|
    # translate
    tr '_' 0		|
    tr -c '0\n' 1	|
    # {{ foldcell
    # == overwrap 3
    awk -v W=3	'
	{	i = (NR % W) ; l[i] = $0 ;	}
	NR >= W{
		o = l[(i+1) % W]
		for(j=1;j<W;j++)	{
			o = o " " l[(i+j+1) % W]
		}
		print o
	}'								|
    # bind 9 cells into 1 cell
    sed -e 's/./& /g'	|
    awk -v X="$X" -v Y="$Y"	'
	BEGIN{	o = X + 2; }
	{	for(i=1;i<=X;i++)	{
			l = ""					# clear
			l = l $(i)     $(i+1)     $(i+2)	# upper cell
			l = l $(o+i)   $(o+i+1)   $(o+i+2)	# middle cell
			l = l $(2*o+i) $(2*o+i+1) $(2*o+i+2)	# lower cell

			print l
		}
	}'									|
    # foldcell }}
    # # the output is one cell per one line
    #
    # apply rules
    sed -e 's/./& /g'	|
    awk -v X="$X" -v Y="$Y"	'
	{	n = 0;
		for(i=1;i<=9;i++)	{	n += $(i)	}

		if($5 == 0)	{	# dead cell
			# RULE1 : reproduction
			if(n == 3)				{	printf("X");	}
			else					{	printf("_");	}
		} else {	# living cell
			# RULE2 : sustain
			if(n == (2 + 1) || n == (3 + 1))	{	printf("X");	}
			# RULE3 : underpopulation
			else if (n <= (1 + 1))			{	printf("_");	}
			# RULE4 : overpopulation
			else if (n >= (4 + 1))			{	printf("_");	}
			# unreachable
			else	{
				print "'"$pname.$stime.$$ ERROR unreachable code section."'"	> "/dev/stderr";
				exit 1;
			}
		}
	}
	END{	printf("\n");	}'	|
    fold -w "$X"

######################################################################
exit 0
